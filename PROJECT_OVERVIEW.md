# PIU 채보 영상 → CSV 추출 프로그램

## Context
YouTube에 올라온 PUMP IT UP 채보 영상(StepF2 등 시뮬레이터 녹화)에서 노트 데이터를 자동 추출하여 CSV 파일로 저장하는 프로그램.
- 입력: YouTube URL + 채보 구간(시작/끝 시간)
- 출력: 10개 패널(더블)의 노트 이벤트가 담긴 CSV 파일

## 핵심 동작 원리

### 노트 감지 방식: Detection Line Scanning
1. 영상에서 수신선(receptor) 근처에 **감지 라인**을 설정
2. 매 프레임마다 10개 컬럼 위치에서 노트 존재 여부를 색상으로 판별
3. "없음→있음" 전환 시점 = 노트 도착 타이밍
4. 여러 프레임 연속 감지 = 롱노트(홀드)

### 패널 배치 (더블 10패널)
```
P1: ↙(DL) ↖(UL) ⬟(C) ↗(UR) ↘(DR) | P2: ↙(DL) ↖(UL) ⬟(C) ↗(UR) ↘(DR)
```

## 사용법
```bash
python piu_extractor.py "https://youtu.be/b-PF13GvPqY" --start 13 --end 108
```
- `--start`: 채보 시작 시간(초)
- `--end`: 채보 끝 시간(초)
- 실행하면 캘리브레이션 창이 뜨고, 클릭 완료 후 자동 분석 시작
- 결과: `chart_output.csv` 파일 생성

## CSV 출력 형식
```csv
time_sec,p1_dl,p1_ul,p1_c,p1_ur,p1_dr,p2_dl,p2_ul,p2_c,p2_ur,p2_dr
0.500,0,0,0,0,0,1,0,0,0,0
0.750,0,0,1,0,0,0,0,0,0,0
1.000,0,0,0,0,0,0,0,0,0,2
3.500,0,0,0,0,0,0,0,0,0,3
```
- 값: 0=없음, 1=탭, 2=홀드시작, 3=홀드끝

## 의존성
```
pip install yt-dlp opencv-python matplotlib numpy pandas
```

## 파일 구조
```
PIU_GET_STEP/
├── PROJECT_OVERVIEW.md    # 프로젝트 개요
├── piu_extractor.py       # 메인 스크립트 (전체 로직)
└── (다운로드된 영상 및 결과 CSV는 실행 시 생성)
```

## 구현 상세

### 1. 영상 다운로드 (yt-dlp)
- YouTube URL → 로컬 mp4 파일 다운로드
- 720p 이하로 다운로드 (처리 속도 최적화)

### 2. 캘리브레이션 (matplotlib 인터랙티브)
- 채보 구간 중간 프레임 1장을 화면에 표시
- 사용자가 **10개 컬럼 위치**를 순서대로 클릭 (P1_DL → P2_DR)
- 사용자가 **감지 라인 Y좌표**를 클릭
- 클릭한 좌표를 JSON으로 저장 (재사용 가능)

### 3. 프레임별 노트 감지 (OpenCV)
- 채보 구간(start~end) 전체 프레임을 순회
- 각 프레임에서 10개 컬럼 × 감지 라인 위치의 작은 ROI(Region of Interest) 추출
- ROI를 HSV 변환 → 채도(Saturation) + 밝기(Value) 기준으로 노트 존재 판별
  - 노트 있음: 높은 채도 + 밝기 (화려한 화살표 색상)
  - 노트 없음: 낮은 채도/밝기 (어두운 배경)

### 4. 후처리: 노트 이벤트 변환
- 연속 감지 프레임들을 개별 노트 이벤트로 변환:
  - **탭 노트**: 짧은 연속 감지 (수 프레임)
  - **홀드 시작**: 긴 연속 감지의 첫 프레임
  - **홀드 끝**: 긴 연속 감지의 마지막 프레임
- 홀드 판별 기준: 연속 감지가 일정 프레임 수(예: 15프레임) 이상이면 홀드

## 검증 방법
1. 예시 영상(b-PF13GvPqY)을 다운로드하여 테스트
2. 캘리브레이션 UI가 정상 동작하는지 확인
3. 생성된 CSV를 열어 노트 타이밍이 합리적인지 확인
4. 영상과 CSV를 대조하여 누락/오탐 확인
